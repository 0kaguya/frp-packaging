name: Build and Release DEB Package

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get latest FRP release version
        id: upstream
        run: |
          # Get the latest release from upstream FRP repository
          LATEST_VERSION=$(curl -s https://api.github.com/repos/fatedier/frp/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          echo "version=${LATEST_VERSION}" >> $GITHUB_OUTPUT
          echo "Latest upstream FRP version: ${LATEST_VERSION}"
      
      - name: Check if release already exists
        id: check
        run: |
          VERSION="${{ steps.upstream.outputs.version }}"
          # Check if this version already has a release in this repo
          if gh release view "v${VERSION}" >/dev/null 2>&1; then
            echo "Release v${VERSION} already exists, skipping build"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release v${VERSION} does not exist, proceeding with build"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Determine version
        id: version
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.upstream.outputs.version }}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building FRP version: ${VERSION}"
      
      - name: Download FRP release
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LINK="https://github.com/fatedier/frp/releases/download/v${VERSION}/frp_${VERSION}_linux_amd64.tar.gz"
          echo "Downloading from: ${LINK}"
          curl -sSL --fail -O "${LINK}"
          tar -zxvf "frp_${VERSION}_linux_amd64.tar.gz"
          ls -la "frp_${VERSION}_linux_amd64"
      
      - name: Build DEB package
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ ! -f scripts/build-deb.sh ]; then
            echo "Error: build-deb.sh script not found"
            exit 1
          fi
          chmod +x scripts/build-deb.sh
          ./scripts/build-deb.sh "frp_${VERSION}_linux_amd64"
          ls -la frp_${VERSION}_linux_amd64.deb
      
      - name: Create Release
        if: steps.check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          files: frp_${{ steps.version.outputs.version }}_linux_amd64.deb
          tag_name: v${{ steps.version.outputs.version }}
          name: FRP v${{ steps.version.outputs.version }}
          body: |
            Debian package for FRP v${{ steps.version.outputs.version }}
            
            ## Installation
            ```bash
            sudo dpkg -i frp_${{ steps.version.outputs.version }}_linux_amd64.deb
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
